name: Update Profile

on:
  # Schedule: Runs once daily at 22:30 UTC (which is 04:00 AM IST)
  schedule:
    - cron: "30 22 * * *"
  # Allows manual run from the Actions tab
  workflow_dispatch:

jobs:
  update-profile:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # ----------------------------------------------------------
      # Step 1: Generate the Visual Metrics (SVG)
      # ----------------------------------------------------------
      - name: Generate GitHub Metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GH_PAT }}
          filename: github-metrics.svg
          # We disable the commit here to batch it later
          output_action: none 
          committer_token: ${{ secrets.GH_PAT }}
          
          # Configuration
          user: trinadhthatakula
          template: classic
          base: header, activity, community, repositories
          config_timezone: Asia/Kolkata
          
          # Plugins to make it look "Senior"
          plugin_lines: yes
          plugin_traffic: yes
          plugin_isocalendar: yes
          plugin_isocalendar_duration: half-year # Full year is too tall
          plugin_languages: yes
          plugin_languages_ignored: html, css, shell # Ignore noise
          plugin_languages_details: lines, percentage

      # ----------------------------------------------------------
      # Step 2: Generate the Text Content (README.md)
      # ----------------------------------------------------------
      - name: Generate README with Scribe
        uses: muesli/readme-scribe@master
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        with:
          template: "README.md.tpl"
          writeTo: "README.md"

      # ----------------------------------------------------------
      # Step 3: Single Commit for Everything
      # ----------------------------------------------------------
      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: daily profile update"
          file_pattern: "README.md github-metrics.svg"
          skip_dirty_check: false    
          skip_fetch: true
